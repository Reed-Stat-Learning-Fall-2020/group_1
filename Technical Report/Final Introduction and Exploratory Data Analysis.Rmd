---
title: "Introduction and Exploratory Data Analysis"
author: "Group 1: Josh Yamamoto, Riley Leonard, Andy Zhao"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(tidymodels)
library(rvest)
library(baseballr)
library(readr)
library(knitr)
```

## Introduction

Since the sport’s inception in the nineteenth century, baseball has remained a fascination of statisticians and data scientists. More recently, the advent of sabermetrics and ball tracking technology has propelled the mathematical study of baseball to new heights, with the ubiquity and accessibility of baseball metrics encouraging more and more professional baseball organizations to adopt an increasingly analytical approach.

A common refrain one hears from baseball fans is that general managers, those responsible for making personnel decisions such as trading a player or signing a free agent to a contract, are slow in adapting to the current trends in analytics. While some front offices, such as the Houston Astros (who boast a nine-man Sabermetric staff), have bought into an analytics-oriented approach, other teams have made their aversion to analytics clear. This disinclination is perhaps best encapsulated by the former Philadelphia Phillies GM Ruben Amaro claiming, back in 2014, that their team was "not a statistics-driven organization by any means". While such a sentiment seems outmoded now, the question remains over how earnestly baseball decision-makers have realistically accepted the growing Sabermetrics movement. 

To investigate this question, we decided to build a variety of models in order to attempt to predict a pitcher’s future contract using their statistics from the past season. The rationale behind this was that, while baseball GMs might profess a certain belief in analytics publicly, the contracts they hand out represent a more verifiable illustration of what they actually value. Fitting a model to predict future salary will help answer this question, as it will allow us to perform inference on the various coefficients or weights placed on different metrics---including both basic counting statistics and more advanced statistics. If baseball front offices have genuinely accepted Sabermetrics to the degree that they claim, then we would expect to see that advanced statistics such as expected weighted on base average (xwoBA) or spin rate to be the strongest predictors of future salary. If, on the other hand, we find that basic counting statistics such as total pitches or total wins are the strongest predictors, it would suggest that baseball GMs are more enamored with counting statistics than they would like to admit.

The second half of our project involves fitting a variety of models to try to predict a pitcher’s earned run average (ERA) in the coming season using statistics from the current season. The reason for this exploration is that we wished to determine if the novel Sabermetric statistics are truly more useful in predicting future performance than basic statistics such as total strikeouts. ERA describes the average number of runs given up by a pitcher over nine innings, and was the chosen metric to act as a proxy for pitching outcome, as it exemplifies a wholistic representation of a pitcher’s performance.

The aims and methods of this exploration differ from previous investigations in that the application of statistical learning models allow for more complexity compared to the single-metric methods that have been used traditionally. While front offices certainly have proprietary models predicting a suite of different outcomes, online, the two methods used for predicting future salary and ERA both rely on basic statistics. For ERA, a post on the baseball statistics website Fangraphs attempted to predict 2011 ERA using 2010 statistics and identified skilled-interactive earned run average (SIERA) as the best predictor of future ERA (1). While the formula behind SIERA is quite complex, its calculation does not utilize Sabermetrics analytics (which were introduced in the 2014 season) in its calculation and its variables are restricted to basic statistics such as total strikeouts and plate appearances. In terms of predicting salary, a commonly used method is to calculate contract value over wins above replacement (WAR) to get the “cost of a win in free agency” (2). The formula for a pitcher’s WAR is quite complex but still does not fully integrate Sabermetrics statistics. Additionally, this method presupposes a linear relationship, which is to say that a 4-win player costs the same as two 2-win players, an assumption that we can circumvent with certain models.

Ultimately, in this project, we aimed to predict both future performance and salary for MLB pitchers. This endeavor allows us to not only understand the metrics that underlie the two response variables, but also to investigate if a discrepancy exists between the predictors responsible for prospective pitching success and those responsible for a lucrative contract. 


(1) https://blogs.fangraphs.com/are-pitching-projections-better-than-era-estimators/
(2) https://blogs.fangraphs.com/the-cost-of-a-win-in-free-agency-in-2020/



## Data Exploration


### Salary Data Exploration

For data exploration, we will explore the correlations and associations between pitching statistics from the 2016-2019 seasons in order to determine if performance in the past year can predict future salary.

A filter was applied to salary to remove salaries lower than 600,000 or pre-arbitration salaries. These players are under team control and their contracts are artificially deflated. Because their low salaries do not reflect their true "market price", they are excluded.



```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
Mega_Summary <- read_csv("Final Mega Summary.csv")

#Filter out Pre-arbitration
Mega_Summary_Filtered <- 
  Mega_Summary %>% 
  filter(salary_t1 > 600000)
```

### Looking at Salary

We began by examining the structure of our first response variable: future salary.



```{r echo=FALSE, fig.height=4, fig.width=6}
ggplot(Mega_Summary_Filtered, 
       aes(x = salary_t1)) + 
  geom_histogram(
    color = "grey100",
    fill = "midnightblue",
    bins = 30, 
    alpha = .75 
    ) + 
  labs(x = "Salary (t+1)",
       y = "Count") +
  theme_classic()
```



As we can see, future salary is quite right skewed. This is understandable, as certain superstar pitchers have salaries that are magnitudes greater than the average starting pitcher. We considered a log tranformation to try to ameliorate this skew.


```{r echo=FALSE, fig.height=4, fig.width=6}
ggplot(Mega_Summary_Filtered, 
       aes(x = log(salary_t1))) + 
  geom_histogram(
    color = "grey100",
    fill = "midnightblue",
    bins = 30, 
    alpha = .75 
    ) + 
  labs(x = "log(Salary (t+1))",
       y = "Count") +
  theme_classic()
```



It would appear as though the log transformation greatly reduced the degree of the previously observed right skew. While a slight left skew may now exist, we will consider log-transforming salary in our models in order to circumvent this extreme right skew.




### Basic Pitching Statistics

Total wins and total losses constitute the most basic pitching statistics, indicating nothing more than the possible discrete outcomes resulting from a pitcher's contribution to a game. Total number of pitches also represents a fairly rudimentary measure of pitching performance and durability. Additionally, raw, unadjusted ERA (or the average number of runs a pitcher allows in a game) is another predictor that one would expect to be associated with salary. Lastly, the number of earned runs (the unprocessed counting statistic used to calculate ERA) stands out as anohter basic predictor in determining future salary.

```{r echo=FALSE. fig.height=4, fig.width=6, message=FALSE}
#Total Wins
ggplot(Mega_Summary_Filtered,
       aes(
         x = W,
         y = `salary_t1`)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Wins",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$W,
   Mega_Summary_Filtered$salary_t1)

#Total Losses
ggplot(Mega_Summary_Filtered,
       aes(
         x = L,
         y = `salary_t1`)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Losses",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$L,
   Mega_Summary_Filtered$salary_t1)

#Total Pitches
ggplot(Mega_Summary_Filtered, 
       aes(
         x = Pitches,
         y = `salary_t1`)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Pitches",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$Pitches,
   Mega_Summary_Filtered$salary_t1)

```



Unsurprisingly, total wins illustrates a moderate, positive correlation with future salary, while total losses shows virtually no relationship with future salary. This observed pattern makes sense, as a pitcher's total number of wins is a historically omnipresent and oft-cited measurement by casual and serious baseball fans alike. Despite the aforementioned factors beyond a pitcher's control, GMs are likely to accure high praise by signing a "winning" pitcher, regardless of how much the pitcher contributed to the team's total wins.

Meanwhile total number of pitches exhibits a moderate, positive correlation with salary. As we will see later on, pitching statistics having to do with productivity or volume of pitches are often highly correlated with salary.


```{r echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Win percent
Mega_Summary_Filtered <- 
  Mega_Summary_Filtered %>% 
  mutate(Win_Percent = W/(W+L)) %>% 
  drop_na()

ggplot(Mega_Summary_Filtered, 
       aes(
         x = Win_Percent,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Win %",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$Win_Percent,
   Mega_Summary_Filtered$salary_t1)

```



Strikingly, a pitcher's win percentage has a lower correlation with future salary than the total number of wins. While wins and losses are inherently flawed statistics, one would imagine that a higher win-loss ratio implies that a pitcher is contributing more directly to a team's sucess and thus deserves a higher salary. Rather, it seems like the total number of wins is the more important statistic in the eyes of GMs.


```{r echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Games played
ggplot(Mega_Summary_Filtered, 
       aes(
         x = G,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Games (G)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$G,
   Mega_Summary_Filtered$salary_t1)

```



Total games played appears to possess a very weak positive relationship with future salary. This is understandable for two reasons, the first being that pitchers who make a lot of appearances are generally more skilled and therefore trusted to appear in more games by managers. Concurrently, highly skilled pitchers are paid well. Secondly, as we have seen throughout this exploration so far, an increase in volume-related statistics generally tends to result in a larger paycheck.


```{r echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Current ERA
ggplot(Mega_Summary_Filtered,
       aes(
         x = `ERA`,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "ERA",
       y = "Salary (t+1)") +
  theme_classic()
cor(Mega_Summary_Filtered$ERA,
    Mega_Summary_Filtered$salary_t1)

```



While ERA does exhibit a negative correlation with future salary, the weakness of the relationship is surprising, as giving up fewer runs is an unequivocally positive outcome for pitchers. The comparison of the relationship between future salary and ERA and future salary and total wins is fascinating, as total wins appears to be more highly valued in the eyes of a GM (despite a pitcher only having a limited amount of control over their team's performance and subsequent game outcomes). In contrast, a pichter's ERA is independent of his team's performance, but nonetheless has a weaker relationship than total wins. What this suggests is that GMs generally do not do a sufficient enough job of isolating an individual pitcher's abilities, and instead place too much weight on counting statistics (such as wins) that are more stochastic and susceptible to noise.




### Season Totals and Percentages 

While season totals might have a murkey relationship with future performance, it is undeniable that statistics such as strikeouts are quite flashy and can therefore lead to lucrative contracts. As a result, season totals might be strong predictors of next year's salary. We first examined total batters faced, total strikeouts, total number of batters walked on balls, total hits, and total home runs allowed.


```{r echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Total batters faced
ggplot(Mega_Summary_Filtered,
       aes(
         x = ABs,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "At Bats (ABs)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$ABs,
    Mega_Summary_Filtered$salary_t1)

#Total strikeouts
ggplot(Mega_Summary_Filtered,
       aes(
         x = SO,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Strikeouts (K)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$SO,
    Mega_Summary_Filtered$salary_t1)

#Total batters walked
ggplot(Mega_Summary_Filtered,
       aes(
         x = BB,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Walks (BB)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$BB,
    Mega_Summary_Filtered$salary_t1)

#Total hits
ggplot(Mega_Summary_Filtered,
       aes(
         x = H,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Hits (H)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$H,
    Mega_Summary_Filtered$salary_t1)

#Total Home Runs
ggplot(Mega_Summary_Filtered,
       aes(
         x = HR,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Home Runs (HR)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$HR,
    Mega_Summary_Filtered$salary_t1)
```


As anticipated, season totals in general have a strong, positive correlation with salary, and, following a trend that we will see again in this exploration, pitching volume can often be more predictive of future salary than pitch quality. 

Total strikeouts and total batters faced have the strongest positive relationships with future salary. This is to be expected, as strikeouts are both the sign of a good pitcher and quite attractive to the average baseball fan. Similarly, a high number of batters faced suggests a well-regarded pitcher that is entrusted with such responsibilities. More unexpectedly, undesirable outcomes like hits and home runs display a medium positive relationship as well. This seemingly contradictory trend perhaps can be explained by the fact that only good pitchers are permitted (by their managers) to play enough games to surrender such a high volume hits and home runs, whereaas less-accomplished pitchers would be given limited playing time. If this hypothesis is true, then batting average against (BA) should be negatively correlated, as BAA is a measurement of what percentage of hitters record a hit against a certain pitcher.

Total number of batters walked on balls has a very weak (close to 0) positive relationship with future salary. This is understandable, as number of batters walked can be more contingent on an individual's style of pitching rather than their quality as a pitcher. Less batters walked simply suggests better control, and superior control in a vacuum does not necessarily suggest a better pitcher.

Next we looked to see if the percent of strikeouts, balls, and hits (BA) are correlated with future salary.


```{r, echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Strikeout Percent
ggplot(Mega_Summary_Filtered,
       aes(
         x = K_percent,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "K %",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$K_percent,
    Mega_Summary_Filtered$salary_t1)

#Percent of Batters walked
ggplot(Mega_Summary_Filtered,
       aes(
         x = BB_percent,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "BB %",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$BB_percent,
    Mega_Summary_Filtered$salary_t1)

#Batting average against (hit percent)
ggplot(Mega_Summary_Filtered,
       aes(
         x = BA,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Batting Average (BA)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$BA,
    Mega_Summary_Filtered$salary_t1)


```


Interestingly, even though strikeout percentage (K %) is still positively correlated with future salary, the strength of the relationship is not as strong as the raw number of strikeouts. Both the percentage of batters walked (BB %) and hit percent (BA) have a moderate to weak negative relationship with future salary. **This supports the previous hypothesis that only good, highly-valued pitchers are allowed to accumulate a large number of hits as simply giving up a lot of hits, for example having a high BA, is negatively correlated with future earning.** Surprisingly, BB % has a stronger negative relationship than BA, despite total number of hits having a stronger correlation with future salary than total number of batters walked. The discrepancy between total batters walked and percentage of batters walked is not easily explained.

We next looked at some season percentages of more advanced statistics such as hard hit % and barrel %. Both of these statistics look at the speed and angle of the ball after being hit by the batter. Barrel % represents batted balls with exit velocities and launch angles that, historically, have led to a minimum .500 batting average (or a 50% chance of resulting in a hit). Hard hit % is similar to barrel %, but does not consider launch angle and simply describes batted balls with exit velocities exceeding 95 MPH. Naively, one would expect a negative relationship, as a good pitcher should try to avoid giving up hard contact.


```{r, echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Hard hit percent
ggplot(Mega_Summary_Filtered,
       aes(
         x = hard_hit_percent,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue")+
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Hard Hit %",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$hard_hit_percent,
    Mega_Summary_Filtered$salary_t1)

#Barrel percent
ggplot(Mega_Summary_Filtered,
       aes(
         x = barrel_percent,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue") +
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Barrel %",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$barrel_percent,
    Mega_Summary_Filtered$salary_t1)
```

Surprisingly, neither of these advanced variables seem to have a clear relationship with future salary. **Barrel %'s relationship with future is marginally stronger than hard hit %'s and is, shockingly, positive**. However, this weak relationship could be explained by noise, as it is unlikely that giving up more hard hits will lead to a larger contract.




### Pitch Averages

Next, we examined if the averages of certain statistics were correlated with salary, specifically looking at average speed and spin rate.


```{r, echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Average Speed
ggplot(Mega_Summary_Filtered,
       aes(
         x = Velocity,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue") +
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Average Velocity (MPH)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$Velocity,
    Mega_Summary_Filtered$salary_t1)

#Average spin rate
ggplot(Mega_Summary_Filtered,
       aes(spin_rate,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue") +
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "Average Spin Rate (RPM)",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$spin_rate,
    Mega_Summary_Filtered$salary_t1)

```

Naively, one might expect faster pitches to be harder to hit and thus expect pitchers with higher average velocities to be handsomely paid. However, the negative **correlation, with a not-insignificant correlation, suggests** that average pitch speed is actually inversely related to salary. There are a couple of reasons why this might be. The most obvious is that pitchers who lack speed often make up for it with stellar control or a wide arsenal of offspeed pitches. Another reason is that, instinctively, average pitch speed might be correlated with certain negative predictors like home runs, as batters can often make hard contact against fast but poorly-placed pitches.

Spin rate is a topic that has garnered increased attention in the baseball community, and is something that pitchers place a lot of emphasis on. It seems that this interest is not misplaced, as there is a moderate positive relationship between spin rate and future salary.




### Advanced Statistics

**We now get to our advanced statistics,** namely weighted on base average (wOBA), batting average on balls in play(BABIP), expected weighted on base average (xwOBA), and expected batting average(xBA). The two expected statistics are notable as they try to remove some of the noise (or "luck"") from the statistic by calculating wOBA and BA based on the historical wOBA and BA of batted balls with similar exit velocities and launch angles. 


```{r, echo=FALSE, fig.height=4, fig.width=6, message=FALSE}
#Weighted on base average (wOBA)
ggplot(Mega_Summary_Filtered,
       aes(
         x = wOBA,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue") +
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "wOBA",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$wOBA,
   Mega_Summary_Filtered$salary_t1)

#Batting average on balls in play against (BABIP)
ggplot(Mega_Summary_Filtered,
       aes(
         x = BABIP,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue") +
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "BABIP",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$BABIP,
   Mega_Summary_Filtered$salary_t1)

#Expected wOBA
ggplot(Mega_Summary_Filtered,
       aes(
         x = xwOBA,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue") +
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "xwOBA",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$xwOBA,
   Mega_Summary_Filtered$salary_t1)

#Expected batting average
ggplot(Mega_Summary_Filtered,
       aes(
         x = xBA,
         y = salary_t1)
       ) +
  geom_point(alpha = 0.5, color = "midnightblue") +
  geom_smooth(method = lm,
              color = "midnightblue") +
  labs(x = "xBA",
       y = "Salary (t+1)") +
  theme_classic()

cor(Mega_Summary_Filtered$xBA,
   Mega_Summary_Filtered$salary_t1)

```

Surprisingly, all 4 advanced statistics had negative correlations, albeit weak ones. This suggests that GMs perhaps are not as adverse to advanced statistics as one would expect. The negative relationship is understandable as these statistics measure the offensive production against the pitcher, thus, smaller values and less potent offenses are desirable. Both wOBA and BABIP have stronger relationships with future salary than expected wOBA and expected BA, which suggests that GMs are still not adequately seperating out noise or luck. 

###Luck Reversion###
These predictors will come in handy later but the idea behind luck reversion was that if a pitcher's wOBA was significantly lower than their expected wOBA, then they would appear to be a better pitcher due to luck alone. Luck reversion for us takes 4 forms, the first two (xwOBA-wOBA and xBA-BA) are simply the difference between expected and observed statistics. The second two (ERA/Hard hit% and ERA/barrel %) operate under the assumption that hard contacts (hard hit% and barrel%) will result in more earned runs and a higher ERA, and if a pitcher's ERA/barrel % is low, then that means that they were lucky in terms of having a lower ERA than their pitching truly warrants.

```{r}
#xwOBA-wOBA
ggplot(Mega_Summary_Filtered,
       aes(
         x = `xwOBA - wOBA`,
         y = `Salary (t+1)`)
       ) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = lm,
              color = "grey50") +
  theme_classic()

cor(Mega_Summary_Filtered$`xwOBA - wOBA`,
   Mega_Summary_Filtered$`Salary (t+1)`)

#xBA-BA
ggplot(Mega_Summary_Filtered,
       aes(
         x = `xBA - BA`,
         y = `Salary (t+1)`)
       ) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = lm,
              color = "grey50") +
  theme_classic()

cor(Mega_Summary_Filtered$`xBA - BA`,
   Mega_Summary_Filtered$`Salary (t+1)`)

#ERA/Hard Hit
ggplot(Mega_Summary_Filtered,
       aes(
         x = `ERA/Hard Hit %`,
         y = `Salary (t+1)`)
       ) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = lm,
              color = "grey50") +
  theme_classic()

cor(Mega_Summary_Filtered$`ERA/Hard Hit %`,
   Mega_Summary_Filtered$`Salary (t+1)`)

#ERA/Barrel
ggplot(Mega_Summary_Filtered,
       aes(
         x = `ERA/Barrel %`,
         y = `Salary (t+1)`)
       ) +
  geom_point(alpha = 0.5)+
  geom_smooth(method = lm,
              color = "grey50") +
  theme_classic()

cor(Mega_Summary_Filtered$`ERA/Barrel %`,
   Mega_Summary_Filtered$`Salary (t+1)`)

```

While xwOBA-wOBA doesn't display any strong relationship, xBA-BA had a moderately strong positive relationship, which suggests that lucky players with lower BA's than expected are getting paid more. This further suggests that GMs really have trouble seperating out luck. This trend is further exemplified with ERA/hard hit or barrel as those with smaller values (luckier pitchers) tend to have higher salaries, as suggested by the positive relationship. This relationship is especially pertinent with ERA/Barrel % which has a sizeable correlation coefficient. Overall, it seems like while GMs are attuned to advanced statistics, they have not yet fully bought into luck-adjusted statistics.

###Correlations Between Predictors###

```{r}
total_quant_pred <- 
  select_if(
    Mega_Summary_Filtered,
    is.numeric
    )

total_quant_pred <- 
  total_quant_pred %>% 
  select(
    -Year,
    -ΔERA,-ΔSalary,
    -`Salary (t+1)`
         )

predictor_correlations <- 
  cor(total_quant_pred)

```

In the interest of saving some space, we will not be printing the entire correlation matrix. However, some salient trends stand out in terms of collinearity.

```{r}
volume_predictors<-Mega_Summary_Filtered %>%select(Pitches,W,L,BFP,H,HR,SO)
volume_predictors_cor<-cor(volume_predictors)
kable(volume_predictors_cor)
```

First of all, the "volume" predictors related to sheer number of pitches and games played are all very highly correlated to each other. Specifically, total pitches, total batters faced, total games, total hits, total strikeouts, total wins, total losses, total home runs all have high R values with each other. These are also some of the stronger predictors in predicting salary. In the interest of avoiding collinearity, we might want to combine these variables.

```{r}
hit_predictors<-Mega_Summary_Filtered %>%select(BA,xBA,`K %`)
hit_predictors_cor<-cor(hit_predictors,Mega_Summary_Filtered$`Spin Rate`)
kable(hit_predictors_cor)
```


Interestingly, spin rate is positively correlated with strike percent and negatively correlated with hit percent. So baseball pundits might be on to something in promoting this statistic as increasing strikes and reducing hits is a positive outcome.

```{r}
barrel_predictors<-Mega_Summary_Filtered %>%select(xBA,wOBA,xwOBA,ERA)
barrel_predictors_cor<-cor(barrel_predictors,Mega_Summary_Filtered$`Barrel %`)
kable(barrel_predictors_cor)
```

Average barrel percentage has a medium positive correlation with our advanced statistics wOBA as well as expected wOBA and expected BA. It is also positively correlated with ERA. This makes sense as harder contact means more runs allowed which means more offense, thus raising the values of the advanced statistics.

```{r}
offense_statistics<-Mega_Summary_Filtered %>%select(`K %`,BA,wOBA,xwOBA)
strikes_and_hits<-Mega_Summary_Filtered %>%select(`K %`,BA)
strikes_hits_statistics_cor<-cor(offense_statistics,strikes_and_hits)
kable(strikes_hits_statistics_cor)
```

Strike and hit %'s were negatively correlated with each other which is reasonable as they are mutually exclusive. Strike % also had high, negative correlations with the wOBA and xWOBA statistics while hit % had a high positive correlation with those two statistics. This is understandable as those statistics try to quantify total offensive output, which consists of accumulating hits while avoiding strikes.

```{r}
advanced_statistics<-Mega_Summary_Filtered %>%select(BABIP,xBA,wOBA,xwOBA)
advanced_statistics_cor<-cor(advanced_statistics,Mega_Summary_Filtered$ERA)
kable(advanced_statistics_cor)
```
Our advanced statistics, BABIP, wOBA, xwOBA, xBA are all quite positively correlated with ERA. Given that the statistics all try to quantify offense and that ERA represents total offensive runs allowed, this relationship is to be expected. 

```{r}
wins_and_lossess<-Mega_Summary_Filtered %>%select(W,L)
wins_and_lossess_cor<-cor(wins_and_lossess,Mega_Summary_Filtered$ERA)
kable(wins_and_lossess_cor)
```

An additional, interesting, observation is that ERA is positively correlated with number of losses with a medium degree of positive correlation , while the inverse relationship between ERA and number of wins is not as strong. This suggests that a poor pitcher with a high ERA can easily lose games while a skilled pitcher with a low ERA cannot win games for his team alone.

Here we have a nice way to visualize some of the correlations that we discussed above. Unfortunately due to the large number of predictors we have, the plot is quite cluttered in some ares.

```{r}
library(corrr)

total_quant_pred %>%
  correlate() %>%
  rearrange() %>%
  shave() %>%
  rplot(shape = 15, colours = c("darkorange", "white","midnightblue")) +
  theme(axis.text.x = element_text(angle = 90))
```



##Predicting Future ERA##

Having explored possible predictors of salary (comparing both simple and complex variables), we move on to our prediction of future Earned Run Average (ERA). In this case, our selected response (ERA) can be thought of as a rough proxy for general pitching performance and outcome. Since the inception of the statistic in the early 1900s, ERA has been the most ubiquitous and cited measure of pitcher effectiveness, as it represents a straightforward calculation of the average amount of runs a pitcher allows over the duration of typical game (with run prevention thought of as the ultimate aim of pitching). Despite ERA being the most functional measure of pitching performance, it is nonetheless subject to a significant deal of random noise between individual pitchers' seasons. The development of advanced pitching analytics therefore may lend itself to more accurate forecasts of future ERA than simple counting statistics (such as wins, strikeouts, and innings pitched). With this in mind, we are motivated to find the statistical model that most accurately predicts ERA in a succesive season given a number of predictors generated from data in the current season. This should allow us to assess and predict player performance not based on actual (occasionally random) outcomes, but rather on an aggregation of predicted outcomes determined by a set of relevant statistical parameters. Ultimately, this model should lend itself to making informed salary decisions by MLB general managers.

```{r message=FALSE, warning=FALSE, paged.print=FALSE}
Mega_Summary <- read_csv("Models/Mega Summary.csv")
pitch_data <- read_csv("Exploratory Data Analysis/2020_summary.csv") %>%
  rename(`Pitch Category` = pitch_category) %>%
  rename(wOBA = wOBAA)
```

```{r}
pitch_data  %>%
  ggplot(aes(
    x = `Average Pitch Speed`,
    y = wOBA)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
pitch_data  %>%
  ggplot(aes(
    x = `Average Pitch Speed`,
    y = wOBA, color =`Pitch Category`)
    ) +
  geom_point(
    size = 2, 
    alpha = 0.5) +
  geom_smooth(method = lm) +
  theme_minimal()
```


The first thing we find in our exploration is that average pitch speed has no meaningful relationship with other measures of pitch performance (such as wOBA), even when the data is almost perfectly seperated by categorical variable level. This is also true of average spin rate, and the results are consistent with different response choices (BA, SLG, etc.). This leads us to conclude that pitch tracking data has no predictive power when it comes to modelling pitcher performance. This helps explain why Statcast uses batted ball variables (such as launch angle and exit velocity) rather than pitch tracking variables as the predictors in the calculation of their expected outcome statistics (such as xwOBA and xBA). Accordingly, we will most likely avoid using average pitch speed and average spin rate in our model and focus on other predictors of future ERA instead.


Ostensibly, the most obvious predictor of forcasted ERA is current ERA, as we can intuitively expect pitchers who performed well in a given season to also perform well in subsequent seasons.


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = ERA,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$ERA, Mega_Summary$`ERA (t+1)`)
```


Despite the expected existence of a postive linear association between the two variables, the correlation between ERA and ERA in the subsequent season is far from perfect. This can likely be explained by the aforementioned influence of randomness in pitching outcomes. This leads us to believe that other variables (or a combination therof) may have more predictive power in forecasting ERA than ERA by itself. 

##Future ERA distribution##

```{r}
ggplot(Mega_Summary, aes(x = `ERA (t+1)` ))+
  geom_histogram(
    color="grey100",
    bins = 30, 
    alpha = .75 )+
  theme_classic()
```
We can see that, unlike future salary, future ERA displays a decently normal distribution. While there is a tiny right tail, the low number of observations in that region make it so that it is unlikely to skew our model. This normal distribution is understandable as the MLB has pitchers with a range of talent, with the majority of them falling around the average. The few outliers in the right tail likely represent injury-ridden seasons or seasons where a pitcher experienced bad luck.

##Correlations Between the Strongest Predictors of Salary and Future ERA##

First, we look at some of the same counting stats that were significant in predicting salary, namely total wins, total pitches, and total strikeouts, which were the three predictors with the highest correlation (quantified through R value) with salary:


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = W,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$W, Mega_Summary$`ERA (t+1)`)
```


The relationship between wins and forcasted ERA is somewhat weak but the negative or inverse relationship is what one would have expected as winning pitchers often have lower ERAs. Thus, while the negative correlation coefficient does support the decision to reward wins with a lucrative contract, the weaker association suggests that the relationship might not be as important as one would have expected looking at salary alone.

```{r}
Mega_Summary %>%
  ggplot(aes(
    x = Pitches,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$Pitches, Mega_Summary$`ERA (t+1)`)
```


Similar to wins, we again see a weak, negative relationship between number of pitches and ERA in the following year. This negative relationship is perhaps a bit more confusing and needs more explanation than the relationship between wins and ERA. What this relationship suggests is that more productive pitchers will tend to have a better or lower ERA next season. This relationship perhaps offers some validation to the correlations between volume of pitches and salary as it suggests that better pitchers simply pitch more often. However, it is worth mentioning that this relationship is more likely due to the fact that only highly-skilled pitchers will be allowed to rack up a large number of total pitchers. That is to say that, while a high number of pitches suggests a more valuable pitcher, making a less-accomplished pitcher pitch more innings will not necessarily improve their value or reduce their ERA.


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = SO,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$SO, Mega_Summary$`ERA (t+1)`)
```


Lastly, we see strikeouts in the previous year shows a decently strong, negative relationship to ERA. Here, the relationship is negative, which is what one would expect as pitchers that record more strikeouts are likely to be at the top of their field and are expected to continue their superb performance in later seasons. The strength of this association is surprising as it is stronger than both games and total pitches.

From this analysis, we see that there is a consistently negative relationship between the top three predictors of salary and the pitcher's ERA the next season. This trend provides some evidence that, perhaps, GMs are doing a better job of properly valuing the right attributes than baseball fans imagine as the three predictors that are the most correlated with salary have a positive relationship to future performance (quantified through a negative relationship with future ERA). This finding is quite surprising as, intuitively, these impressive basic counting statistics should provide little to no indication as to future performance. One potential explanation for this is that these basic statistics are correlated with but, crucially, do not cause better future performance. That is to say that only "good" pitchers will be allowed to face a large number of batters and thus will accumulate a large number of these counting statistics.

Despite the fact that the salary-associated predictors are already quite good at predicting future ERA, we hypothesize that advanced statistics such as xWOBA or xBA are going to be better predictors of future performance than the salary-correlated predictors.

##Correlations between Advanced Statistics and Future ERA##

The advanced statistics we considered were strikeout percent (K%), weighted on base average (wOBA), expected weighted on base average (xwOBA), and batting average on balls in play (BABIP).

```{r}
Mega_Summary %>%
  ggplot(aes(
    x = `K %`,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$`K %`, Mega_Summary$`ERA (t+1)`)
```


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = wOBA,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$wOBA, Mega_Summary$`ERA (t+1)`)
```


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = xwOBA,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$xwOBA, Mega_Summary$`ERA (t+1)`)
```

```{r}
Mega_Summary %>%
  ggplot(aes(
    x = BABIP,
    y = `ERA (t+1)`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$BABIP, Mega_Summary$`ERA (t+1)`)
```

Already, we see that the more advanced analytics have, on average, stronger correlations with future ERA than the more rudimentary counting statistics. Additionally, we see that expected weighted on-base average (xwOBA) outperforms weighted on-base average (wOBA). Unlike wOBA, xwOBA attempts to mitigate some of the stochasticity in pitching outcomes by aggregating batted ball data to predict results. In some ways, we can think of xwOBA has a more true measure of pure pitching performance than wOBA, which helps explain why it has a stronger correlation with future ERA. This also allows us to explore the difference between outcome-based statistics (like wOBA) and estimates of expected outcome (like xwOBA) as a measure of a pitcher's "luck", that is how much better or worse batters performed against the pitcher than expected (based on the quality of aontact allowed). 

##Luck Reversion##

Considering that we previously had discussed how total strikeouts is a very potent predictor of future salary, it is unsurprising that strikeout % has the strongest correlation, even stronger than total strikeouts, as it offers a more nuanced approach than the unadjusted total.

A further extension of comparing the differences in outcome and expected outcome is to determine if those differences tend to correct themselves over time. To do so, we analyze the change in a pitcher's ERA from one season to the next as explained by the difference between different predictive and raw measures: 


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = `BABIP - Mean BABIP`,
    y = `ΔERA`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$`BABIP - Mean BABIP`, Mega_Summary$`ΔERA`)
```


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = `xBA - BA`,
    y = `ΔERA`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$`xBA - BA`, Mega_Summary$`ΔERA`)
```


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = `xwOBA - wOBA`,
    y = `ΔERA`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm,
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$`xwOBA - wOBA`, Mega_Summary$`ΔERA`)
```


```{r}
Mega_Summary %>%
  ggplot(aes(
    x = `ERA/Hard Hit %`,
    y = `ΔERA`)
    ) +
  geom_point(alpha = 0.5) +
  geom_smooth(
    method = lm, 
    color = "grey50"
    ) +
  theme_classic()
```

```{r}
cor(Mega_Summary$`ERA/Hard Hit %`, Mega_Summary$`ΔERA`)
```


As we see in the data, there is clear statistical evidence of what we could call "mean-reversion of luck". Pitchers whose actual performances were worse than expected performances generally saw an increase in ERA the next season as their "luck" reverted closer to the mean. The opposite can be said for pitchers who performed better than exopcted. 

```{r}
cor(Mega_Summary$`ERA (t+1)`, Mega_Summary$`ΔERA`)
```

Considering the very strong, positive relationship between change in ERA (ΔERA) and future ERA (ERA (t+1)), this conclusion suggests that including differences in outcome-based statistics and expected statistics (especially in accordance with base year ERA) should have significant predictive power in forecasting future ERA.


#Conclusion#

Ultimately, the top 5 highest correlations for future salary are Pitches, ABs, W, H and HR, while the 5 predictors most associated with future ERA are wOBA, BA, xBA, xwOBA,and K %.

```{r}
salary_pred<-Mega_Summary_Filtered %>%select(Pitches, ABs, W, H, HR)
salary_pred_cor<-cor(salary_pred,Mega_Summary_Filtered$`Salary (t+1)`)
kable(salary_pred_cor)
```

```{r}
future_ERA_pred<-Mega_Summary_Filtered %>%select(wOBA, BA, xBA, xwOBA, `K %`)
future_ERA_pred_cor<-cor(future_ERA_pred,Mega_Summary_Filtered$`ERA (t+1)`)
kable(future_ERA_pred_cor)
```

From our preliminary data exploration, it appears that slight discrepancies exist between the predictors that are associated with salary and the predictors associated with future performance. Specifically, it seems like raw, unadjusted counting stats associated with volume of pitches rather than quality are highly correlated with salary and have moderate correlations with future ERA, suggesting that baseball GMs might be prudent in rewarding those statistics. However, advanced statistics, especially statistics that calculate expected values, are better predictors of future performance, despite not being highly correlated with salary. We also elucidated the phenomenon of a "mean-reversion of luck" which suggests that a pitcher's expected performance, derived from statistics such as xWOBA and xBA rather than just WOBA and BA, can help remove some of the noise associated with luck and stochastic fluctuations. Overall, it appears that the differences in strength of correlation between salary and future performance are significant, our next step will be to create and fine-tune models to predict both response variables to both futher delineate what predictors the models differ on as well as investigate both over- and under-paid or valued pitchers.

